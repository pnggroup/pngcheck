name: release
on:
  push:
    tags:
    - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows ${{ matrix.arch }}
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: Win32
            vcpkg_triplet: x86-windows
            artifact_name: pngcheck-windows-x86.exe
          - arch: x64
            vcpkg_triplet: x64-windows
            artifact_name: pngcheck-windows-x64.exe
          - arch: ARM64
            vcpkg_triplet: arm64-windows
            artifact_name: pngcheck-windows-arm64.exe

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Install vcpkg dependencies
      run: |
        vcpkg install zlib:${{ matrix.vcpkg_triplet }}

    - name: Configure CMake
      run: |
        cmake -B build -A ${{ matrix.arch }} -DCMAKE_BUILD_TYPE=Release -DPNGCHECK_USE_SYSTEM_ZLIB=ON -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake

    - name: Build
      run: cmake --build build --config Release

    - name: Prepare release artifacts
      run: |
        mkdir release-artifacts
        cp build/Release/pngcheck.exe release-artifacts/${{ matrix.artifact_name }}
        cd release-artifacts
        Get-FileHash -Algorithm SHA256 *.exe | ForEach-Object { "$($_.Hash.ToLower())  $($_.Path | Split-Path -Leaf)" } > checksums-${{ matrix.arch }}.txt

    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pngcheck-windows-${{ matrix.arch }}
        path: release-artifacts/
        retention-days: 90

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-windows
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: all-artifacts

    - name: Prepare release assets
      run: |
        mkdir -p release-assets
        find all-artifacts -type f \( -name "*.exe" -o -name "checksums-*.txt" \) -exec cp {} release-assets/ \;
        cd release-assets
        cat checksums-*.txt > checksums.txt
        rm checksums-*.txt
        ls -la

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: pngcheck ${{ github.ref_name }}
        body: |
          ## pngcheck ${{ github.ref_name }}

          ### Windows Binaries

          | File | Architecture |
          |------|--------------|
          | `pngcheck-windows-x86.exe` | Windows 32-bit (x86) |
          | `pngcheck-windows-x64.exe` | Windows 64-bit (x64) |
          | `pngcheck-windows-arm64.exe` | Windows ARM64 |

          Built with MSVC and zlib. SHA256 checksums included.
        files: release-assets/*
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}
